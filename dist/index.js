import{$,rgbToHex}from"./src/js/methods.js";import APIchrome from"./src/js/chromeAPI.js";let Chrome=new APIchrome;class colors extends Array{constructor(e){super(),this.maxColors=e}pushColor(e){"object"!=typeof e&&(e={note:e}),e.font||(e.font="black"),e.tack||(e.tack="#E50909"),this.push(e)}reset(){for(;this.length>0;)this.pop()}get[Symbol.toStringTag](){return"colors"}}class pallete{constructor(){this.palletes=[],this.test=[],this.tempColor,this.colorSelected,this.popup={toolbar:$("#toolbar"),options:$("#optionsMenu"),mininote:{font:$(".falseLetter"),note:$("#miniNote"),tack:$("#miniTack")},newStyle:$(".newStyle"),inputColor:function(e){return"all"==e?$(".icolor"):(e=e.substring(0,1).toUpperCase()+e.substring(1,e.length),$("#colorInput"+e))},bubble:$("#bubbleInfo"),allPalletes:$(".allPalletes"),pallete:e=>$("#pallete-"+e),colors:(e="all")=>$("all"==e?".colorsPallete":"."+e+"Color"),color:(e,t)=>$("#color-"+e+t)}}async setNewPallete(e,t,o,l=0){let i=document.createElement("ul");i.classList="palletes",i.id="pallete-"+e,this.popup.allPalletes.appendChild(i),this.palletes[e]=new colors(o);for(let o in t)this.setColor(t[o],e,!1);Chrome.setStorage("pallete-"+e,this.palletes[e]),this.activeColor(l,e,"load")}setColor(e,t,o=!0){this.palletes[t].pushColor(e);let l=this.palletes[t].length-1,i=this.popup.pallete(t);l>=this.palletes[t].maxColors&&1==o?this.showBubbleMessage('<div id="warningMsg"></div>Paleta llena!'):l<this.palletes[t].maxColors&&i.insertBefore(this.newColor(t,l),i.children[0]),1==o&&Chrome.setStorage("pallete-"+t,this.palletes[t])}newColor(e,t){let o=document.createElement("li");return o.id="color-"+e+t,o.classList+=e+"Color colorsPallete",o.style.backgroundColor=this.palletes[e][t].note,o.onclick=(()=>{this.activeColor(t,e)}),o}selectedColor(e,t,o){this.popup.colors("all").forEach(function(e,t){e.css({transform:"scale(1)"})}),this.popup.color(e,t).css({transform:"scale(1.4)"}),this.popup.mininote.note.style.backgroundColor=o.note,this.popup.mininote.tack.style.backgroundColor=o.tack,this.popup.mininote.font.forEach(function(e,t){e.style.backgroundColor=o.font}),this.tempColor&&(o.font=rgbToHex(o.font),o.note=rgbToHex(o.note),o.tack=rgbToHex(o.tack),this.newStyleSelectColors(o.note,o.font,o.tack)),this.colorSelected={pallete:e,key:t,colors:this.palletes[e][t]},Chrome.setStorage("colorNoteSelect",{pallete:e,key:t,colors:this.palletes[e][t]})}async loadColors(e,t){let o=await Chrome.getStorage("colorNoteSelect");return"empty"!=o?o:this.palletes[e][t]}async activeColor(e,t,o="click",l={pallete:"default",key:0}){let i,s=!1;"load"==o?(i=await this.loadColors(t,e))&&this.palletes[i.pallete]&&this.palletes[i.pallete][i.key]||(i=this.palletes[l.pallete][l.key],t=l.pallete,e=l.key,s=!0):i=this.palletes[t][e],i.colors&&0==s&&(e=i.key,t=i.pallete,i=i.colors),this.selectedColor(t,e,i)}}class popup extends pallete{constructor(){super(),this.urlActive,this.setNewPallete("default",[{note:"#2f3640",font:"white"},"#fd9644","#f1c40f","#26de81","#2bcbba","#9c88ff"].reverse(),6,2);(async()=>{let e=await Chrome.getStorage("pallete-user");e="empty"==e?[]:e,this.setNewPallete("user",e,18)})(),this.toggles={menuDelete:!1,menuHidden:async()=>await new Promise(async(e,t)=>{let o=await Chrome.getStorage("hiddenNotes");return"empty"!=o?e(o):t("show")})},window.addEventListener("click",e=>{e.target.id&&"optionsMenu"!=e.target.id&&"optionButton"!=e.target.id&&1==this.popup.options.style.opacity&&(this.popup.options.style.opacity=0,this.popup.options.style.visibility="hidden")},!1),Chrome.onMessages({notesDelete:e=>{let t=(e=e.notesDelete)>1||0==e?"s":"";this.showBubbleMessage("("+e+") <i>&nbsp nota"+t+" eliminada"+t+"</i>")},accessUrlBloked:()=>{this.showBubbleMessage('<div id="warningMsg"></div> PÃ¡gina no accesible!',2500)},recivedUrlActive:e=>{this.urlActive=e.url;for(let t=e.url.length-1;t>=0;t--)if("/"==e.url[t]){this.urlActive=e.url.substring(0,t)+"/*";break}let t=$("#viewUrl");t.textContent=this.urlActive,t.css({visibility:"visible"}),t.scrollLeft=t.scrollWidth}}),this.menuHidden("show"),(async()=>{let e=await Chrome.getStorage("anchorDomainCheck");1==e?($("#anchorDomain").checked=!0,this.anchorDomainActive(!0)):0==e&&($("#anchorDomain").checked=!1,this.anchorDomainActive(!1))})(),$("#anchorDomain").on("change",async()=>{this.anchorDomainActive()}),$("#miniNote").on("click",async()=>{let e;if(this.tempColor)e=this.tempColor;else{let t=await Chrome.getStorage("colorNoteSelect");e=this.palletes[t.pallete][t.key]}Chrome.send({verifyURL:"createNote",noteColor:e.note,fontColor:e.font,tackColor:e.tack,anchorDomain:$("#anchorDomain").checked,urlAnchor:this.urlActive})}),this.popup.colors("user"),$("#closeNewStyle").on("click",()=>{this.closeNewStyle()}),$("#deleteButton").on("click",()=>{this.menuDelete()}),$("#deleteConfirm").on("click",()=>{this.deleteNotes(),this.menuDelete()}),$("#hiddenButton").on("click",()=>{this.menuHidden("toggle")}),$("#optionButton").on("click",()=>{this.optionsMenu()}),$("#newStyle").on("click",()=>{this.newStyle()}),$("#btn-guardarEstilo").on("click",()=>{this.setColor(this.tempColor,"user")}),$("#deleteStyle").on("click",()=>{this.menuDeleteStyle(!0)}),$("#deleteCancel").on("click",()=>{this.menuDeleteStyle(!1)}),$("#deleteAllColor").on("click",()=>{this.menuDeleteStyle(!1),Chrome.removeStorage("pallete-user");document.querySelectorAll(".userColor").forEach(function(e,t){e.style.display="none"}),this.palletes.user.reset()})}menuDeleteStyle(e="auto"){0==e?$("#config-deleteColor").css({visibility:"hidden",height:"0px",paddingBottom:"0px"}):$("#config-deleteColor").css({visibility:"visible",height:"20px",paddingBottom:"3px"})}async anchorDomainActive(e=null){let t=$("#viewUrl"),o=$("#anchorDomain");if(o.checked=null!=e?e:o.checked,1==o.checked)if(this.urlActive)t.textContent=this.urlActive,t.css({visibility:"visible"}),t.scrollLeft=t.offsetLeft;else{await Chrome.send({action:"sendUrlActive"})}else t.css({visibility:"hidden"}),t.textContent="";Chrome.setStorage("anchorDomainCheck",o.checked)}closeNewStyle(){this.tempColor=void 0,this.popup.newStyle.animate({height:"20px",visibility:"visible"},{visibility:"hidden",height:"0px"},10)}newStyle(){this.popup.newStyle.animate({height:"0"},{height:"20px",visibility:"visible"},200);let e=(e,t,o)=>{null!=e&&(this.popup.mininote.note.style.backgroundColor=$(e+" input").value,$(e).style.backgroundColor=$(e+" input").value),null!=t&&(this.popup.mininote.font.forEach(function(e,o){e.style.backgroundColor=$(t+" input").value}),$(t).style.backgroundColor=$(t+" input").value),null!=o&&(this.popup.mininote.tack.style.backgroundColor=$(o+" input").value,$(o).style.backgroundColor=$(o+" input").value)},t=rgbToHex(this.popup.mininote.note.style.backgroundColor),o=rgbToHex(this.popup.mininote.font[0].style.backgroundColor),l=rgbToHex(this.popup.mininote.tack.style.backgroundColor);this.newStyleSelectColors(t,o,l);let i=$("#noteColor input"),s=$("#fontColor input"),n=$("#tackColor input");i.on("input",()=>{e("#noteColor",null,null),this.tempColor.note=i.value}),s.on("input",()=>{e(null,"#fontColor",null),this.tempColor.font=s.value}),n.on("input",()=>{e(null,null,"#tackColor"),this.tempColor.tack=n.value})}newStyleSelectColors(e,t,o){this.tempColor={note:e,font:t,tack:o},$("#noteColor input").value=e,$("#noteColor").style.backgroundColor=e,$("#fontColor input").value=t,$("#fontColor").style.backgroundColor=t,$("#tackColor input").value=o,$("#tackColor").style.backgroundColor=o}optionsMenu(e){let t=function(e){return"visible"==e||"hidden"==e?"visible"==e?"hidden":"visible":0==e||1==e?1==e?0:1:void 0};this.popup.options.style.pointerEvents="all",this.popup.options.animate({opacity:t(this.popup.options.style.opacity),visibility:t(this.popup.options.style.visibility)},{opacity:t(this.popup.options.style.opacity),visibility:t(this.popup.options.style.visibility)},200)}showBubbleMessage(e,t=2500,o={color:"#f1c40f",font:"black"}){let l=$("#bubbleInfo");l.style.backgroundColor=o.back,l.style.color=o.font,l.innerHTML=e,l.animate({opacity:"1"},{opacity:"0"},2e3)}menuHidden(e){let t=$("#hiddenButton"),o={toggle:e=>{let o="hidden"==e?"show":"hidden";"hidden"==e?(Chrome.send({action:"showNotes"}),t.style.backgroundColor="transparent",Chrome.setStorage("hiddenNotes",o)):"show"==e&&(Chrome.send({action:"hiddenNotes"}),t.style.backgroundColor="#f39c12",Chrome.setStorage("hiddenNotes",o))},show:e=>{"hidden"==e?(Chrome.setStorage("hiddenNotes","hidden"),t.style.backgroundColor="#f39c12"):(Chrome.setStorage("hiddenNotes","show"),t.style.backgroundColor="transparent")}};this.toggles.menuHidden().then(t=>o[e](t),t=>o[e](t))}async deleteNotes(){let e={allHere:function(){let e=$("#allHere");return e.bind="removeNotesHere",e},allPages:function(){let e=$("#allPages");return e.bind="deleteAll",e},checked:function(){return this.allHere().checked?this.allHere():this.allPages()}}.checked().bind;switch(e){case"deleteAll":Chrome.send({action:e});break;case"removeNotesHere":let t=await Chrome.getTab("active");Chrome.send({action:e,url:t[0].url},t[0].id)}}menuDelete(){let e=$("#deleteMenu");0==this.toggles.menuDelete?($("#deleteButton").style.backgroundColor="#f39c12",e.animate({display:"flex"},{opacity:"1",visibility:"visible"},150),this.toggles.menuDelete=!0):($("#deleteButton").style.backgroundColor="transparent",e.animate({opacity:"0",visibility:"hidden"},{display:"none"},150),this.toggles.menuDelete=!1)}}new popup;