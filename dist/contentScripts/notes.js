class controllerLoad extends dragDrop{constructor(){super(),this.id=this.getID(),this.svgIcons={config:'<svg class="configSvgEx0A" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M487.4 315.7l-42.6-24.6c4.3-23.2 4.3-47 0-70.2l42.6-24.6c4.9-2.8 7.1-8.6 5.5-14-11.1-35.6-30-67.8-54.7-94.6-3.8-4.1-10-5.1-14.8-2.3L380.8 110c-17.9-15.4-38.5-27.3-60.8-35.1V25.8c0-5.6-3.9-10.5-9.4-11.7-36.7-8.2-74.3-7.8-109.2 0-5.5 1.2-9.4 6.1-9.4 11.7V75c-22.2 7.9-42.8 19.8-60.8 35.1L88.7 85.5c-4.9-2.8-11-1.9-14.8 2.3-24.7 26.7-43.6 58.9-54.7 94.6-1.7 5.4.6 11.2 5.5 14L67.3 221c-4.3 23.2-4.3 47 0 70.2l-42.6 24.6c-4.9 2.8-7.1 8.6-5.5 14 11.1 35.6 30 67.8 54.7 94.6 3.8 4.1 10 5.1 14.8 2.3l42.6-24.6c17.9 15.4 38.5 27.3 60.8 35.1v49.2c0 5.6 3.9 10.5 9.4 11.7 36.7 8.2 74.3 7.8 109.2 0 5.5-1.2 9.4-6.1 9.4-11.7v-49.2c22.2-7.9 42.8-19.8 60.8-35.1l42.6 24.6c4.9 2.8 11 1.9 14.8-2.3 24.7-26.7 43.6-58.9 54.7-94.6 1.5-5.5-.7-11.3-5.6-14.1zM256 336c-44.1 0-80-35.9-80-80s35.9-80 80-80 80 35.9 80 80-35.9 80-80 80z"/></svg>',disket:'<?xml version="1.0" encoding="UTF-8"?>\n<svg class="disketSvgEx0A" width="438.53px" height="438.53px" enable-background="new 0 0 438.533 438.533" version="1.1" viewBox="0 0 438.533 438.533" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">\n  <path d="m432.82 121.05c-3.806-9.132-8.377-16.367-13.709-21.695l-79.941-79.942c-5.325-5.325-12.56-9.895-21.696-13.704-9.131-3.805-17.508-5.708-25.12-5.708h-264.95c-7.611 0-14.084 2.663-19.414 7.993-5.33 5.327-7.992 11.799-7.992 19.414v383.72c0 7.617 2.662 14.089 7.992 19.417 5.33 5.325 11.803 7.991 19.414 7.991h383.72c7.618 0 14.089-2.666 19.417-7.991 5.325-5.328 7.987-11.8 7.987-19.417v-264.95c0-7.616-1.902-15.99-5.708-25.129zm-250.1-75.372c0-2.474 0.905-4.611 2.714-6.423 1.807-1.804 3.949-2.708 6.423-2.708h54.819c2.468 0 4.609 0.902 6.417 2.708 1.813 1.812 2.717 3.949 2.717 6.423v91.362c0 2.478-0.91 4.618-2.717 6.427-1.808 1.803-3.949 2.708-6.417 2.708h-54.819c-2.474 0-4.617-0.902-6.423-2.708-1.809-1.812-2.714-3.949-2.714-6.427v-91.362zm146.18 356.31h-219.27v-109.64h219.27v109.64zm73.094 0h-36.559v-118.77c0-7.617-2.663-14.085-7.991-19.417-5.328-5.328-11.8-7.994-19.41-7.994h-237.54c-7.614 0-14.087 2.666-19.417 7.994-5.327 5.328-7.992 11.8-7.992 19.417v118.77h-36.545v-365.45h36.544v118.77c0 7.615 2.662 14.084 7.992 19.414 5.33 5.327 11.803 7.993 19.417 7.993h164.46c7.61 0 14.089-2.666 19.41-7.993 5.325-5.327 7.994-11.799 7.994-19.414v-118.77c2.854 0 6.563 0.95 11.136 2.853 4.572 1.902 7.806 3.805 9.709 5.708l80.232 80.23c1.902 1.903 3.806 5.19 5.708 9.851 1.909 4.665 2.857 8.33 2.857 10.994v255.81z"/>\n</svg>'}}async getID(e){let t,o=document.querySelectorAll(".noteEx0A");if(o.length>0?(t=o[o.length-1].idnote,t++):t=1,e){let o=!0,n=t;return await new Promise(async(t,i)=>{do{await new Promise(async(t,o)=>{"empty"!=await this.getStorage([e.url+n])?o():t(n)}).then(function(e){o=!1,t(e)},()=>{n++})}while(1==o)})}return t}cleanNotesPageDynamic(){document.querySelectorAll(".removeEx0A").forEach(function(e,t){let o=document.querySelector("#paperEx"+e.id.replace("removeEx",""));o&&""!=o.value&&e.delete()}),document.querySelectorAll(".removeEx0A").forEach(function(e,t){let o=document.querySelector("#anchor-paperEx"+e.id.replace("anchor-removeEx",""));o&&""!=o.value&&e.delete()})}async loadNotes(e){let t=async(e,t,o=!1)=>{let n=0,i=0;for(let s=1;s<=300;s++){const r=await this.getStorage(t+s);if((n="empty"!=r?0:n++)>e)break;if("empty"!=r){let e;(e=0==o?document.getElementById("noteEx"+r.id):document.getElementById("anchor-noteEx"+r.id))||(i++,this.createNote(r,s,o))}}return i};t(50,e.url);let o=this.getAnchorUrl(e.url,!1);for(let e in o)t(50,o[e],!0)}}class noteText extends controllerLoad{constructor(){super(),this.temp=[],this.default={position:"center",width:"4.3cm",height:"4.3cm",fontSize:"28px",textContent:""}}async setConfigContainer(e,t,o,n){e.menu.style.backgroundColor=o.noteColor,this.on(e.iconConfig,"click",()=>{this.onConfigColor(e,o,t,n),this.animate(e.menu,{opacity:"0",visibility:"hidden"},{opacity:"1",visibility:"visible"},60,!0)}),window.addEventListener("click",t=>{e.menu.contains(t.target)||(this.css(e.menu,{opacity:"0",visibility:"hidden"}),e.menu.toggleAction="open")});let i,s,r;i=(n=0==n?"":"anchor-")+"anchorDomainEx"+t,s=n+"viewUrlEx"+t,r=n+"colorsEx"+t,e.menu.insertAdjacentHTML("beforeend",'\n            <span>Texto</span><br>\n              <input type="number" value="'+e.text.style.fontSize.replace("px","")+'" /> px<br>\n            <span>Color</span><br>\n              <div class="colorsEx0A" id="'+r+'">\n              \n              </div>\n              <span class="anchorDomainEx0A"><label>Anclar al sub/dominio</label> <input type="checkbox"  id="'+i+'">\n                <div class="viewUrlEx0A" id="'+s+'"></div>\n              </span>\n\n    ')}async createNote(e,t="auto",o=!1){let n="auto"==t?await this.getID(e):t;this.id=n,1==e.anchorDomain&&(o=!0),this.requestFormat(e);let i=this.getModelTextNote(n,e,o);return this.setRequest(i,e),this.setConfigContainer(i,n,e,o),this.onDelete(i,n,o),this.onAutoSave(i,n,e),this.onShowInfo(i,n),this.setNoteDOM(i.fusion()),this.onDrag(i.note.id,i.area.id),this.setPosition(i,e.position),this.onConfigColor(i,e,n,o),this.onConfigTenxSize(i,e,n),this.onConfigAnchorDomain(e,n,i,o),document.querySelector("#anchorDomainEx"+n+" label").style.color=e.fontColor,document.querySelector("#"+i.iconConfig.id+" svg").style.fill=e.fontColor,document.querySelector("#"+i.save.id+" svg").style.fill=e.fontColor,n}getAnchorUrl(e,t=!0){let o=[];for(let n=e.length-1;n>=0;n--)if("/"==e[n]){if(1==t)return e.substring(0,n)+"/*";o.push(e.substring(0,n)+"/*")}return o}onConfigAnchorDomain(e,t,o,n){let i,s;0==n?(i=document.querySelector("#anchorDomainEx"+t),s=document.querySelector("#viewUrlEx"+t)):(i=document.querySelector("#anchor-anchorDomainEx"+t),s=document.querySelector("#anchor-viewUrlEx"+t));let r=this.getAnchorUrl(e.url);i.checked=e.anchorDomain,o.span.idExtension=0==i.checked?e.url+t:r+t,s.textContent=1==i.checked?this.getAnchorUrl(e.url):"",e.urlAnchor=s.textContent,i.addEventListener("change",async()=>{e.anchorDomain=i.checked,0==i.checked?(e.urlAnchor="",s.textContent="",this.removeStorage(r+t),this.send({action:"sendUrlContentScript",response:"urlContentScript"},null,n=>{e.url=n.url,o.span.idExtension=e.url+t,this.saveTextNote(o,e,t,50)})):(o.span.idExtension=r+t,e.urlAnchor=r,s.textContent=e.urlAnchor,this.removeStorage(e.url+t),this.saveTextNote(o,e,t,50))},!1)}async saveTextNote(e,t,o,n=10){""!=e.text.value&&(this.temp[o]&&clearTimeout(this.temp[o]),this.temp[o]=setTimeout(()=>{let o=e.note.idnote,n=t.urlAnchor&&""!=t.urlAnchor?t.urlAnchor:t.url;this.setStorage(n+o,{fontSize:e.text.style.fontSize,fontColor:t.fontColor,noteColor:t.noteColor,text:e.text.value,id:o,url:t.url,position:{x:e.note.style.left,y:e.note.style.top},width:e.text.clientWidth+"px",height:e.text.clientHeight+"px",tackColor:t.tackColor,anchorDomain:t.anchorDomain,urlAnchor:t.urlAnchor}),e.info.show(null)},n))}onDelete(e,t,o){e.span.delete=(()=>{0==o?document.body.removeChild(document.getElementById("areaEx"+t)):document.body.removeChild(document.getElementById("anchor-areaEx"+t))}),e.span.addEventListener("click",async()=>{await this.removeStorage([e.span.idExtension]),e.span.delete()},!1)}onShowInfo(e,t){e.info.show=function(t,o=2e3){return this.textContent=t,null!=t?(this.style.setProperty("height","auto","important"),this.style.setProperty("padding","2px 4px","important")):e.save.style.opacity="1",setTimeout(()=>{this.textContent="",this.style.setProperty("height","0","important"),this.style.setProperty("padding","0px 0px","important"),e.save.style.opacity="0"},o)}}setNoteDOM(e){e.style.height=document.body.clientHeight+"px";document.body.insertBefore(e,(()=>{let e=this.getID();return 1==e?document.body.children[0]:document.body.children[e]})())}onAutoSave(e,t,o){e.saveAuto=(n=>{e.text.addEventListener("keyup",n=>{this.saveTextNote(e,o,t,2e3)}),e.note.addEventListener("dragend",n=>{this.saveTextNote(e,o,t)}),((e,t,o,n)=>{var i=t.text.clientWidth,s=t.text.clientHeight;t.text.addEventListener("mouseup",()=>{t.text.clientWidth==i&&t.text.clientHeight==s||this.saveTextNote(t,o,n,e),i=t.text.clientWidth,s=t.text.clientHeight})})(50,e,o,t)}),e.saveAuto(2e3)}setRequest(e,t){e.note.style.background=t.noteColor,e.text.value=t.text,this.css(e.text,{color:t.fontColor,width:t.width,height:t.height,fontSize:t.fontSize,lineHeight:t.fontSize}),e.menu.style.color=t.fontColor,e.tack.style.backgroundColor=t.tackColor}getModelTextNote(e,t,o){let n=(o,n,i)=>{let s=document.createElement(o);return i=1==i?"anchor-":"",s.classList+=n+"Ex0A notranslate",s.id=i+n+"Ex"+e,s.idnote=e,s.idExtension=t.url+s.idnote,s},i=this.svgIcons;return{area:n("div","area",o),note:n("div","note",o),span:n("span","remove",o),tack:n("div","tack",o),info:n("span","message",o),text:n("textarea","paper",o),iconConfig:n("button","config",o),menu:n("ul","menuConfig",o),save:n("span","saveIcon",o),fusion:function(){return this.tack.appendChild(this.span),this.note.appendChild(this.info),this.note.appendChild(this.tack),this.save.insertAdjacentHTML("beforeend",i.disket),this.note.appendChild(this.save),this.note.appendChild(this.text),this.iconConfig.insertAdjacentHTML("beforeend",i.config),this.note.appendChild(this.iconConfig),this.note.appendChild(this.menu),this.area.appendChild(this.note),this.area}}}requestFormat(e){e.position=e.position?e.position:this.default.position,e.width=e.width?e.width:this.default.width,e.height=e.height?e.height:this.default.height,e.fontSize=e.fontSize?e.fontSize:this.default.fontSize,e.text=e.text?e.text:this.default.textContent}setPosition(e,t){"center"==t?(e=>{this.css(e.note,{position:"absolute",top:window.scrollY+e.note.clientHeight/2+"px",left:e.note.offsetLeft+"px",visibility:"visible"}),e.area.style.visibility="hidden"})(e):((t,o)=>{this.css(e.note,{position:"absolute",top:o,left:t,visibility:"visible"}),e.area.style.visibility="hidden"})(t.x,t.y)}onConfigTenxSize(e,t,o){let n=document.querySelector("#"+e.menu.id+" input");this.on(n,"change",()=>{this.css(e.text,{fontSize:n.value+"px",lineHeight:n.value+"px"}),this.saveTextNote(e,t,o)})}async onConfigColor(e,t,o,n){document.querySelectorAll(".colorSelectEx0A").forEach(function(e,t){e.parentNode.removeChild(e)});let i=(e,o,i)=>{let s=document.createElement("div");s.classList+=" colorSelectEx0A",s.style.backgroundColor=e.note,n=0==n?"":"anchor-",document.querySelector("#"+n+"colorsEx"+i).appendChild(s),s.addEventListener("click",()=>{document.querySelector("#anchorDomainEx"+i+" label").style.color=e.font,this.css([o.note,o.menu],{backgroundColor:e.note,color:e.font}),o.tack.style.backgroundColor=e.tack,o.text.style.color=e.font,document.querySelector("#"+o.iconConfig.id+" svg").style.fill=e.font,document.querySelector("#"+o.save.id+" svg").style.fill=e.font,t.tackColor=e.tack,t.noteColor=e.note,t.fontColor=e.font,this.saveTextNote(o,t,i,50)},!1)},s=await this.getStorage("pallete-default"),r=await this.getStorage("pallete-user");for(let t in s.reverse())i(s[t],e,o);for(let t in r)i(r[t],e,o)}}